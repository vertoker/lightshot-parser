from datetime import datetime
import requests, os, random
from bs4 import BeautifulSoup
import PySimpleGUI as gui

HEADERS = {'User-Agent': 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.0.7) Gecko/2009021910 Firefox/3.0.7'}

layout = [
	[gui.Text('Введите папку для сохранения'), gui.InputText(key = 'file'), 
	gui.FolderBrowse(key = 'button_file')],
	[gui.Text('Счётчик', key='lbl_count', font='consalo 14'),
	gui.InputText('', key='edit_count', size=(10,1), pad=(10,10)),
	gui.Text('Сид (для рандома)', key='lbl_seed', font='consalo 14'),
	gui.InputText('', key='edit_seed', size=(10,1), pad=(10,10)),],
	[gui.Button('Скачать', key='download'), gui.Text('', key='logger')]
]

def valid(text):
    if len(text)==1 and text in '+-':
        return True
    else:
        try:
            number = float(text)
            return True
        except:
            return False

def dec_to_base(base):
	if not hasattr(dec_to_base, 'table'):
		dec_to_base.table = '1234567890abcdefghigklmnopqrstuvwxyz'
	x, y = divmod(36, base)
	return dec_to_base(x, base) + dec_to_base.table[y] if x else dec_to_base.table[y]

def saveImage(url, pathFolder, counter, time):
	session = requests.Session()
	response = session.get(url, headers = HEADERS)
	soup = BeautifulSoup(response.text, features="lxml")
	image_meta = str(soup.find('meta', {'property': 'og:image'}))
	image_link = image_meta.split("\"")[1]

	image = requests.get(image_link)
	if not os.path.exists(pathFolder):
		os.mkdir(pathFolder)
	out = open(os.path.join(pathFolder, "img " + time + " " + str(counter) + ".jpg"), "wb")
	out.write(image.content)
	out.close()

def getRandomID():
	mod = dec_to_base(random.randrange(1, 2176782336))
	return ('0' * (6 - len(mod))) + mod

gui.theme('DarkAmber')
window = gui.Window('Парсер для картинок LightShot', layout)

def logger(message):
	window['logger'].update(value = message)

def download(count, seed):
	random.Random(seed)
	for x in range(1, int(count)):
		link = "https://prnt.sc/" + str(getRandomID())
		saveImage(link, values['file'], x, datetime.now())
		logger('Загружено скриншотов: ' + str(x))
	logger('Все скриншоты загружены')

while True:
	event, values = window.read()
	#print(event, values) #debug
	if event in (None, 'Exit', 'Cancel'):
		break
	if event == 'download':
		if valid(values['edit_count']) and valid(values['edit_seed']):
			download(values['edit_count'], values['edit_seed'])
		else:
			logger('Данные введены неверно')
